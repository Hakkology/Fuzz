@page "/Admin/Models"
@using Fuzz.Domain.Entities
@using Fuzz.Domain.Services
@using Fuzz.Domain.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject IAiConfigService ConfigService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudStack Spacing="6">
        <MudText Typo="Typo.h4" Class="gradient-text">Model Management (Admin)</MudText>

        <MudPaper Elevation="4" Class="pa-8 blur-card">
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-4">Add New Global Model</MudText>
            <MudGrid>
                <MudItem xs="12" sm="3">
                    <MudSelect T="AiProvider" @bind-Value="_newModel.Provider" Label="Provider" Variant="Variant.Outlined">
                        <MudSelectItem Value="@AiProvider.Gemini">Gemini</MudSelectItem>
                        <MudSelectItem Value="@AiProvider.OpenAI">OpenAI</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField @bind-Value="_newModel.ModelId" Label="Model ID (e.g., gpt-5)" Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="_newModel.DisplayName" Label="Display Name (e.g., GPT-5 Next Gen)" Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="8">
                    <MudText Typo="Typo.subtitle2">Capabilities</MudText>
                    <MudStack Row="true">
                        <MudCheckBox @bind-Value="_capText" Label="Text" Color="Color.Primary" />
                        <MudCheckBox @bind-Value="_capVisual" Label="Visual" Color="Color.Secondary" />
                        <MudCheckBox @bind-Value="_capSound" Label="Sound" Color="Color.Info" />
                        <MudCheckBox @bind-Value="_capVoice" Label="Voice" Color="Color.Warning" />
                    </MudStack>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveModel" FullWidth="true" Style="height: 56px">Add</MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Elevation="4" Class="pa-8 blur-card">
            <MudTable Items="_models" Hover="true" Elevation="0" Class="transparent-table">
                <HeaderContent>
                    <MudTh>Provider</MudTh>
                    <MudTh>Model ID</MudTh>
                    <MudTh>Display Name</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Capabilities</MudTh>
                    <MudTh>Action</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudChip T="string" Color="@GetColor(context.Provider)" Size="Size.Small">@context.Provider</MudChip>
                    </MudTd>
                    <MudTd>@context.ModelId</MudTd>
                    <MudTd>@context.DisplayName</MudTd>
                    <MudTd>
                        @(context.IsCustom ? "Custom" : "Global")
                    </MudTd>
                    <MudTd>
                         @if (context.Capabilities.HasFlag(AiCapabilities.Text)) { <MudIcon Icon="@Icons.Material.Filled.TextFormat" Title="Text" Size="Size.Small" Class="mr-1"/> }
                         @if (context.Capabilities.HasFlag(AiCapabilities.Visual)) { <MudIcon Icon="@Icons.Material.Filled.Visibility" Title="Visual" Color="Color.Secondary" Size="Size.Small" Class="mr-1"/> }
                         @if (context.Capabilities.HasFlag(AiCapabilities.Sound)) { <MudIcon Icon="@Icons.Material.Filled.MusicNote" Title="Sound" Color="Color.Info" Size="Size.Small" Class="mr-1"/> }
                         @if (context.Capabilities.HasFlag(AiCapabilities.Voice)) { <MudIcon Icon="@Icons.Material.Filled.Mic" Title="Voice" Color="Color.Warning" Size="Size.Small" Class="mr-1"/> }
                    </MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteModel(context.Id))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    </MudStack>
</MudContainer>

<style>
    .blur-card {
        background: rgba(26, 26, 46, 0.8) !important;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 107, 53, 0.2);
        border-radius: 20px !important;
    }
    .gradient-text {
        background: linear-gradient(135deg, #FF6B35, #FF8F5E);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
    }
    .transparent-table { background: transparent !important; }
    .transparent-table th { color: #FF6B35 !important; font-weight: bold; }
    .transparent-table td { color: white !important; }
</style>

@code {
    private List<FuzzAiModel> _models = new();
    private FuzzAiModel _newModel = new() { Provider = AiProvider.Gemini };
    
    // Checkbox bindings
    private bool _capText = true;
    private bool _capVisual;
    private bool _capSound;
    private bool _capVoice;

    protected override async Task OnInitializedAsync()
    {
        await RefreshList();
    }

    private async Task RefreshList()
    {
        _models = await ConfigService.GetModelsAsync();
    }

    private Color GetColor(AiProvider p) => p switch {
        AiProvider.Gemini => Color.Info,
        AiProvider.OpenAI => Color.Success,
        _ => Color.Default
    };

    private async Task SaveModel()
    {
        if (string.IsNullOrWhiteSpace(_newModel.ModelId) || string.IsNullOrWhiteSpace(_newModel.DisplayName)) {
            Snackbar.Add("Please fill in all fields.", Severity.Warning);
            return;
        }

        // Combine capabilities
        AiCapabilities caps = 0;
        if (_capText) caps |= AiCapabilities.Text;
        if (_capVisual) caps |= AiCapabilities.Visual;
        if (_capSound) caps |= AiCapabilities.Sound;
        if (_capVoice) caps |= AiCapabilities.Voice;
        
        if (caps == 0) caps = AiCapabilities.Text; // Default Fallback

        _newModel.Capabilities = caps;

        await ConfigService.AddModelAsync(_newModel);
        Snackbar.Add("Model added successfully.", Severity.Success);
        
        // Reset
        _newModel = new FuzzAiModel { Provider = _newModel.Provider };
        _capText = true;
        _capVisual = false;
        _capSound = false;
        _capVoice = false;

        await RefreshList();
    }

    private async Task DeleteModel(int id)
    {
        await ConfigService.DeleteModelAsync(id);
        Snackbar.Add("Model deleted.", Severity.Warning);
        await RefreshList();
    }
}
