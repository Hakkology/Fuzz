@page "/agent-visual"
@rendermode InteractiveServer
@using Fuzz.Domain.Entities
@using Fuzz.Domain.Services.Interfaces
@using Fuzz.Domain.Services.AI
@inject IEnumerable<IVisualAgentService> VisualServices
@inject IAiConfigService ConfigService
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-4 visual-container">
        
        @* Header *@
        <div class="visual-header">
            <MudAvatar Color="Color.Secondary" Size="Size.Medium">
                <MudIcon Icon="@Icons.Material.Filled.ImageSearch" />
            </MudAvatar>
            <div class="visual-header-text">
                <MudText Typo="Typo.h6">Fuzz Visual AI</MudText>
                @if (_activeConfig != null)
                {
                    <MudText Typo="Typo.caption" Style="color: #B0B0B0;">
                        Using <b>@_activeConfig.Provider</b> (@_activeConfig.ModelId)
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.caption" Style="color: #B0B0B0;">Image recognition assistant</MudText>
                }
            </div>
            <MudChip T="string" Color="@(_activeConfig != null ? Color.Success : Color.Error)" Size="Size.Small" Variant="Variant.Outlined">
                @(_activeConfig != null ? "Active" : "Not Configured")
            </MudChip>
        </div>

        @* Image Preview & Upload *@
        <MudFileUpload T="IBrowserFile" Accept=".jpg, .jpeg, .png, .webp" FilesChanged="HandleFileUpload">
            <ActivatorContent>
                <div class="image-preview-area @(_imageData == null ? "empty" : "")">
                    @if (_imageData != null)
                    {
                        <img src="@_imageDataUrl" alt="Uploaded image" class="preview-image" />
                        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                       Size="Size.Small" 
                                       Color="Color.Error"
                                       Class="remove-image-btn"
                                       OnClick="@(e => RemoveImage())" />
                        
                        @if (_isProcessing)
                        {
                            <div class="processing-overlay">
                                <MudProgressCircular Color="Color.Secondary" Indeterminate="true" Size="Size.Large" />
                                <MudText Typo="Typo.subtitle2" Class="mt-2 text-white">Analyzing Image...</MudText>
                            </div>
                        }
                    }
                    else
                    {
                        <MudStack AlignItems="AlignItems.Center" Spacing="1" Class="upload-placeholder">
                            <MudIcon Icon="@Icons.Material.Filled.AddPhotoAlternate" Size="Size.Large" Color="Color.Primary" />
                            <MudText Typo="Typo.body1" Color="Color.Surface">Drop an image here</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">JPEG, PNG, WebP (Max 10MB)</MudText>
                        </MudStack>
                    }
                </div>
            </ActivatorContent>
        </MudFileUpload>

        @* Response Area *@
        @if (!string.IsNullOrEmpty(_response))
        {
            <MudPaper Elevation="0" Class="response-area fade-in">
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="Size.Small" Class="mr-1" /> 
                        Analysis Result
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small" Color="Color.Primary" OnClick="CopyToClipboard" />
                </div>
                <MudText Typo="Typo.body2" Style="line-height: 1.6;">@((MarkupString)FormatResponse(_response))</MudText>
            </MudPaper>
        }

        @* Input Area *@
        <div class="visual-input-area">
            <MudTextField @bind-Value="_prompt" 
                          Placeholder="Ask something about the image..." 
                          Variant="Variant.Filled" 
                          DisableUnderline="true"
                          Class="rounded-lg"
                          OnKeyDown="@HandleKeyDown"
                          Disabled="@(_isProcessing || _imageData == null)"
                          Immediate="true"
                          FullWidth="true"
                          Lines="1" 
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.ChatBubbleOutline"/>
            
            <MudIconButton Icon="@(_isProcessing ? Icons.Material.Filled.Stop : Icons.Material.Filled.Send)" 
                           Color="Color.Secondary" 
                           Variant="Variant.Filled"
                           Size="Size.Medium"
                           Class="send-btn"
                           OnClick="ProcessImage" 
                           Disabled="@(string.IsNullOrWhiteSpace(_prompt) || _imageData == null || (_isProcessing && false))" />
        </div>
    </MudPaper>
</MudContainer>
@inject IJSRuntime JSRuntime

<style>
    .visual-container {
        /* Using Surface color with some transparency */
        background: rgba(26, 26, 46, 0.95) !important; 
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 107, 53, 0.2); /* Primary color border */
        border-radius: 24px !important;
        display: flex;
        flex-direction: column;
        gap: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    .visual-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 107, 53, 0.15); /* Primary color separator */
    }
    
    .visual-header-text {
        flex: 1;
    }
    
    .image-preview-area {
        position: relative;
        min-height: 240px;
        max-height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        overflow: hidden;
        /* Slightly lighter than background */
        background: rgba(22, 33, 62, 0.6); 
        border: 2px dashed rgba(255, 107, 53, 0.3); /* Primary dashed border */
        transition: all 0.3s ease;
    }

    .image-preview-area:hover {
        border-color: rgba(255, 107, 53, 0.6);
        background: rgba(22, 33, 62, 0.8);
    }

    .image-preview-area.empty {
        cursor: pointer;
    }
    
    .preview-image {
        max-width: 100%;
        max-height: 500px;
        object-fit: contain;
        border-radius: 12px;
    }
    
    .remove-image-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(0,0,0,0.6) !important;
        backdrop-filter: blur(4px);
    }

    .processing-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 15, 35, 0.85); /* Dark background overlay */
        backdrop-filter: blur(4px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 16px;
    }
    
    .upload-placeholder {
        padding: 40px;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    .upload-placeholder:hover {
        opacity: 1;
    }
    
    .response-area {
        /* Tertiary color background */
        background: rgba(22, 33, 62, 0.4) !important; 
        border: 1px solid rgba(255, 107, 53, 0.2);
        border-left: 3px solid #FF6B35; /* Primary accent */
        border-radius: 16px !important;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .visual-input-area {
        display: flex;
        gap: 12px;
        align-items: center;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 107, 53, 0.15);
    }

    .send-btn {
        height: 56px;
        width: 56px;
        border-radius: 16px !important;
    }
</style>

@code {
    private byte[]? _imageData;
    private string? _imageDataUrl;
    private string _prompt = "";
    private string _response = "";
    private bool _isProcessing = false;
    private FuzzAiConfig? _activeConfig;

    protected override async Task OnInitializedAsync()
    {
        await CheckActiveConfig();
    }

    private async Task CheckActiveConfig()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
        
        _activeConfig = await ConfigService.GetActiveConfigAsync(userId, mode: AiCapabilities.Visual);
    }

    private async Task HandleFileUpload(IBrowserFile file)
    {
        if (file == null) return;
        
        if (file.Size > 10 * 1024 * 1024)
        {
            Snackbar.Add("Image must be less than 10MB", Severity.Warning);
            return;
        }

        using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        _imageData = ms.ToArray();
        _imageDataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(_imageData)}";
        _response = "";
    }

    private void RemoveImage()
    {
        _imageData = null;
        _imageDataUrl = null;
        _response = "";
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !_isProcessing && _imageData != null)
        {
            await ProcessImage();
        }
    }

    private async Task ProcessImage()
    {
        if (_imageData == null || string.IsNullOrWhiteSpace(_prompt)) return;

        _isProcessing = true;
        _response = "";

        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "guest";

            // Get active config again to be sure
            await CheckActiveConfig();
            
            if (_activeConfig == null)
            {
                _response = "⚠️ No visual AI configured. Please configure one in Settings.";
                return;
            }

            // Select service based on active provider
            IVisualAgentService? visualService = _activeConfig.Provider switch
            {
                AiProvider.Local => VisualServices.OfType<LocalVisualService>().FirstOrDefault(),
                AiProvider.Gemini => VisualServices.OfType<GeminiVisualService>().FirstOrDefault(),
                AiProvider.OpenAI => VisualServices.OfType<OpenAiVisualService>().FirstOrDefault(),
                _ => null
            };

            if (visualService == null)
            {
                _response = $"⚠️ Service not found for {_activeConfig.Provider}.";
                return;
            }

            var result = await visualService.ProcessImageAsync(_imageData, _prompt, userId);
            _response = result.Answer;
        }
        catch (Exception ex)
        {
            _response = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task CopyToClipboard()
    {
        if (string.IsNullOrEmpty(_response)) return;
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _response);
        Snackbar.Add("Copied to clipboard!", Severity.Success);
    }

    private string FormatResponse(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        content = System.Web.HttpUtility.HtmlEncode(content);
        content = System.Text.RegularExpressions.Regex.Replace(content, @"\*\*(.+?)\*\*", "<strong>$1</strong>");
        content = content.Replace("\n", "<br/>");
        return content;
    }
}
