@page "/Settings"
@using Fuzz.Domain.Data
@using Fuzz.Domain.Entities
@using Fuzz.Domain.Services.Interfaces
@using Fuzz.Web.Components.Pages.Dialog
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject IAiConfigService ConfigService
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar
@inject ILogger<Settings> Logger
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-16">
    <MudStack Spacing="6">
        
        @* Header & Intro *@
        <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 700;">Agent Settings</MudText>
        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Manage your Text and Visual AI agents. Connect to Cloud APIs or Local Ollama models.</MudText>

        @* Main Configuration Area *@
        <MudCard Elevation="3" Class="rounded-lg">
            <MudTabs ActivePanelIndex="_activeTabIndex" Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="Color.Transparent">
                
                @* 1. TEXT AI AGENTS *@
                <MudTabPanel Text="Text AI Agents" Icon="@Icons.Material.Filled.Chat" Style="font-weight: bold;">
                    <AgentTextSettings 
                        UserId="@_userId" 
                        AllModels="@_allModels" 
                        OnConfigAdded="LoadConfigs" 
                        OnModelsUpdated="LoadModels" />
                </MudTabPanel>

                @* 2. VISUAL AI AGENTS *@
                <MudTabPanel Text="Visual AI Agents" Icon="@Icons.Material.Filled.ImageSearch" Style="font-weight: bold;">
                    <AgentVisualSettings 
                        UserId="@_userId" 
                        AllModels="@_allModels" 
                        OnConfigAdded="LoadConfigs" 
                        OnModelsUpdated="LoadModels" />
                </MudTabPanel>

                @* 3. SOUND AI AGENTS *@
                <MudTabPanel Text="Sound AI Agents" Icon="@Icons.Material.Filled.MusicNote" Style="font-weight: bold;">
                    <AgentSoundSettings 
                        UserId="@_userId" 
                        AllModels="@_allModels" 
                        OnConfigAdded="LoadConfigs" 
                        OnModelsUpdated="LoadModels" />
                </MudTabPanel>

            </MudTabs>
        </MudCard>

        @* Configurations Grid *@
        <MudText Typo="Typo.h5" Class="mt-4" Color="Color.Primary">Active Configurations</MudText>
        
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (!_configs.Any())
        {
             <MudPaper Class="pa-8 d-flex flex-column align-center justify-center mud-background-gray rounded-lg" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.SettingsSuggest" Size="Size.Large" Color="Color.Default" Style="opacity: 0.5;" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">No agents configured yet</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Add a text or visual agent above to get started.</MudText>
            </MudPaper>
        }
        else
        {
            <MudGrid>
                @foreach (var config in _configs)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudCard Elevation="3" Class="rounded-lg h-100 d-flex flex-column transition-card">
                            <MudCardHeader>
                                <CardHeaderAvatar>
                                    <MudAvatar Color="@GetProviderColor(config.Provider)" Variant="Variant.Filled">
                                        <MudIcon Icon="@GetProviderIcon(config.Provider)" />
                                    </MudAvatar>
                                </CardHeaderAvatar>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: bold;">@config.Provider</MudText>
                                    <MudText Typo="Typo.caption">@config.ModelId</MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" AnchorOrigin="Origin.BottomRight">
                                        <MudMenuItem Icon="@Icons.Material.Filled.Tune" OnClick="@(() => OpenParametersDialog(config.Id))">Parameters</MudMenuItem>
                                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteConfig(config.Id))">Delete</MudMenuItem>
                                    </MudMenu>
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" 
                                             Color="@(config.Mode == AiCapabilities.Visual ? Color.Secondary : (config.Mode == AiCapabilities.Sound ? Color.Tertiary : Color.Primary))">
                                        @config.Mode
                                    </MudChip>
                                     <MudSwitch T="bool" Value="config.IsActive" ValueChanged="@((bool val) => SetActive(config))" Color="Color.Success" Label="@(config.IsActive ? "Active" : "Inactive")" LabelPosition="LabelPosition.Start" />
                                </MudStack>
                                @if(!string.IsNullOrEmpty(config.ApiBase)) {
                                    <MudText Typo="Typo.caption" Class="d-block mt-2 text-truncate" Color="Color.Default">@config.ApiBase</MudText>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </MudStack>
</MudContainer>

<style>
    .transition-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .transition-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
    }
</style>

@code {
    private List<FuzzAiConfig> _configs = new();
    private List<FuzzAiModel> _allModels = new();
    
    // We maintain basic state for tabs
    private int _activeTabIndex = 0;
    
    private string _userId = "";
    private bool _isLoading = true;

    private Color GetProviderColor(AiProvider provider) => provider switch
    {
        AiProvider.Gemini => Color.Info,
        AiProvider.OpenAI => Color.Success,
        AiProvider.Local => Color.Warning,
        _ => Color.Default
    };

    private string GetProviderIcon(AiProvider provider) => provider switch
    {
        AiProvider.Gemini => Icons.Material.Filled.AutoAwesome,
        AiProvider.OpenAI => Icons.Material.Filled.Bolt,
        AiProvider.Local => Icons.Material.Filled.SettingsInputHdmi,
        _ => Icons.Material.Filled.QuestionMark
    };

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            
            if (!string.IsNullOrEmpty(_userId))
            {
                await LoadModels();
                await LoadConfigs();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading settings.");
            Snackbar.Add("Failed to initialize settings.", Severity.Error);
        }
    }

    private async Task LoadModels()
    {
        _allModels = await ConfigService.GetModelsAsync();
        // Trigger state change so children re-render if they rely on AllModels
        StateHasChanged();
    }

    private async Task LoadConfigs()
    {
        if (string.IsNullOrEmpty(_userId)) return;

        _isLoading = true;
        try
        {
            _configs = await ConfigService.GetUserConfigsAsync(_userId);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SetActive(FuzzAiConfig config)
    {
        // Deactivate others of the same type
        foreach(var c in _configs.Where(x => x.Mode == config.Mode)) 
        {
            c.IsActive = false;
        }
        
        config.IsActive = true;
        StateHasChanged();

        try
        {
            await ConfigService.SetActiveConfigAsync(config.Id, _userId);
            // Optionally reload to be sure
            await LoadConfigs(); 
        }
        catch
        {
            Snackbar.Add("Failed to update status.", Severity.Error);
            await LoadConfigs();
        }
    }

    private async Task DeleteConfig(int id)
    {
        await ConfigService.DeleteConfigAsync(id);
        await LoadConfigs();
    }

    private async Task OpenParametersDialog(int configId)
    {
        var parameters = new DialogParameters { ["ConfigId"] = configId };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<AiParameterDialog>("Parameters", parameters, options);
    }
}
