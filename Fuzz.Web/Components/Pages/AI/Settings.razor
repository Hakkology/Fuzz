@page "/Settings"
@using Fuzz.Domain.Data
@using Fuzz.Domain.Entities
@using Fuzz.Domain.Services.Interfaces
@using Fuzz.Web.Components.Pages.Dialog
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject IAiConfigService ConfigService
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar
@inject ILogger<Settings> Logger
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-16">
    <MudStack Spacing="6">
        
        @* Header & Intro *@
        <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 700;">AI Configuration</MudText>
        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Manage your Text and Visual AI agents. Connect to Cloud APIs or Local Ollama models.</MudText>

        @* Main Configuration Area *@
        <MudCard Elevation="3" Class="rounded-lg">
            <MudTabs ActivePanelIndex="_activeTabIndex" ActivePanelIndexChanged="OnOuterTabChanged" Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="Color.Transparent">
                
                @* 1. TEXT AI AGENTS *@
                <MudTabPanel Text="Text AI Agents" Icon="@Icons.Material.Filled.Chat" Style="font-weight: bold;">
                    <MudText Typo="Typo.h6" Class="mb-4">Text Generation Models</MudText>
                    <MudText Typo="Typo.body2" Class="mb-6">Configure agents for chat, coding, and text analysis.</MudText>
                    
                    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-4" ActivePanelIndexChanged="OnInnerTabChanged" Color="Color.Surface" SliderColor="Color.Primary">
                        <MudTabPanel Text="Cloud API" Icon="@Icons.Material.Filled.Cloud">
                            <MudGrid Spacing="3" Class="mt-2">
                                <MudItem xs="12" sm="4">
                                    <MudSelect T="AiProvider" Value="_newConfig.Provider" ValueChanged="OnProviderChanged" Label="Provider" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" AdornmentIcon="@Icons.Material.Filled.Api" AdornmentColor="Color.Primary">
                                        <MudSelectItem Value="@AiProvider.Gemini">Google Gemini</MudSelectItem>
                                        <MudSelectItem Value="@AiProvider.OpenAI">OpenAI</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudSelect T="string" @bind-Value="_newConfig.ModelId" Label="Model" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" AdornmentIcon="@Icons.Material.Filled.SmartToy" AdornmentColor="Color.Secondary">
                                        @foreach (var model in _availableModels)
                                        {
                                            <MudSelectItem Value="@model.ModelId">@model.DisplayName</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_newConfig.ApiKey" Label="API Key" InputType="InputType.Password" Variant="Variant.Outlined" Required="true" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Key" />
                                </MudItem>
                                <MudItem xs="12" Class="d-flex justify-end">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddConfiguration" Disabled="_isSaving" Size="Size.Large" Class="px-8 rounded-pill">
                                        Add Text Agent
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                        
                        <MudTabPanel Text="Local (Ollama)" Icon="@Icons.Material.Filled.Computer">
                             <MudGrid Spacing="3" Class="mt-2">
                                <MudItem xs="12" sm="12">
                                     <MudAlert Severity="Severity.Info" Variant="Variant.Text" NoIcon="true" Class="mb-2">Ensure Ollama is running safely on your machine.</MudAlert>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_newConfig.ApiBase" Label="Ollama URL" Placeholder="http://localhost:11434" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Link" />
                                </MudItem>
                                <MudItem xs="12" sm="6" Class="d-flex align-center">
                                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="RefreshLocalModels" FullWidth="true" Style="height: 56px;">
                                        Refresh Local Models
                                    </MudButton>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudSelect T="string" @bind-Value="_newConfig.ModelId" Label="Select Model" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                        @foreach (var model in _availableModels)
                                        {
                                            <MudSelectItem Value="@model.ModelId">@model.DisplayName</MudSelectItem>
                                        }
                                        <MudSelectItem Value="@("custom")">Custom Model ID...</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                                @if(_newConfig.ModelId == "custom") {
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_customModelId" Label="Enter Model ID" Variant="Variant.Outlined" />
                                    </MudItem>
                                }
                                <MudItem xs="12" Class="d-flex justify-end">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddConfiguration" Disabled="_isSaving" Size="Size.Large" Class="px-8 rounded-pill">
                                        Add Local Agent
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                    </MudTabs>
                </MudTabPanel>

                @* 2. VISUAL AI AGENTS *@
                <MudTabPanel Text="Visual AI Agents" Icon="@Icons.Material.Filled.ImageSearch" Style="font-weight: bold;">
                    <MudText Typo="Typo.h6" Class="mb-4">Visual Recognition Models</MudText>
                    <MudText Typo="Typo.body2" Class="mb-6">Configure agents capable of analyzing images (e.g., GPT-4o, Gemini Vision, LLaVA).</MudText>

                     <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-4" ActivePanelIndexChanged="OnInnerTabChanged" Color="Color.Surface" SliderColor="Color.Secondary">
                        <MudTabPanel Text="Cloud API" Icon="@Icons.Material.Filled.Cloud">
                             <MudGrid Spacing="3" Class="mt-2">
                                <MudItem xs="12" sm="4">
                                    <MudSelect T="AiProvider" Value="_newConfig.Provider" ValueChanged="OnProviderChanged" Label="Provider" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" AdornmentIcon="@Icons.Material.Filled.Api" AdornmentColor="Color.Secondary">
                                        <MudSelectItem Value="@AiProvider.Gemini">Google Gemini</MudSelectItem>
                                        <MudSelectItem Value="@AiProvider.OpenAI">OpenAI</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudSelect T="string" @bind-Value="_newConfig.ModelId" Label="Visual Model" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" AdornmentIcon="@Icons.Material.Filled.RemoveRedEye" AdornmentColor="Color.Warning">
                                        @foreach (var model in _availableModels)
                                        {
                                            <MudSelectItem Value="@model.ModelId">@model.DisplayName</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_newConfig.ApiKey" Label="API Key" InputType="InputType.Password" Variant="Variant.Outlined" Required="true" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Key" />
                                </MudItem>
                                <MudItem xs="12" Class="d-flex justify-end">
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddConfiguration" Disabled="_isSaving" Size="Size.Large" Class="px-8 rounded-pill">
                                        Add Visual Agent
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                        
                         <MudTabPanel Text="Local (Ollama)" Icon="@Icons.Material.Filled.Computer">
                             <MudGrid Spacing="3" Class="mt-2">
                                <MudItem xs="12" sm="12">
                                     <MudAlert Severity="Severity.Info" Variant="Variant.Text" NoIcon="true" Class="mb-2">Use models like <b>llava</b>, <b>bakllava</b>, or <b>moondream</b>.</MudAlert>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_newConfig.ApiBase" Label="Ollama URL" Placeholder="http://localhost:11434" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Link" />
                                </MudItem>
                                <MudItem xs="12" sm="6" Class="d-flex align-center">
                                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="RefreshLocalModels" FullWidth="true" Style="height: 56px;">
                                        Refresh Local Models
                                    </MudButton>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudSelect T="string" @bind-Value="_newConfig.ModelId" Label="Select Visual Model" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                        @foreach (var model in _availableModels)
                                        {
                                            <MudSelectItem Value="@model.ModelId">@model.DisplayName</MudSelectItem>
                                        }
                                        <MudSelectItem Value="@("custom")">Custom Model ID...</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                                @if(_newConfig.ModelId == "custom") {
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_customModelId" Label="Enter Model ID" Variant="Variant.Outlined" />
                                    </MudItem>
                                }
                                <MudItem xs="12" Class="d-flex justify-end">
                                    <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Add" OnClick="AddConfiguration" Disabled="_isSaving" Size="Size.Large" Class="px-8 rounded-pill">
                                        Add Local Visual Agent
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                    </MudTabs>
                </MudTabPanel>
            </MudTabs>
        </MudCard>

        @* Configurations Grid *@
        <MudText Typo="Typo.h5" Class="mt-4" Color="Color.Primary">Active Configurations</MudText>
        
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (!_configs.Any())
        {
             <MudPaper Class="pa-8 d-flex flex-column align-center justify-center mud-background-gray rounded-lg" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.SettingsSuggest" Size="Size.Large" Color="Color.Default" Style="opacity: 0.5;" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">No agents configured yet</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Add a text or visual agent above to get started.</MudText>
            </MudPaper>
        }
        else
        {
            <MudGrid>
                @foreach (var config in _configs)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudCard Elevation="3" Class="rounded-lg h-100 d-flex flex-column transition-card">
                            <MudCardHeader>
                                <CardHeaderAvatar>
                                    <MudAvatar Color="@GetProviderColor(config.Provider)" Variant="Variant.Filled">
                                        <MudIcon Icon="@GetProviderIcon(config.Provider)" />
                                    </MudAvatar>
                                </CardHeaderAvatar>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: bold;">@config.Provider</MudText>
                                    <MudText Typo="Typo.caption">@config.ModelId</MudText>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" AnchorOrigin="Origin.BottomRight">
                                        <MudMenuItem Icon="@Icons.Material.Filled.Tune" OnClick="@(() => OpenParametersDialog(config.Id))">Parameters</MudMenuItem>
                                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteConfig(config.Id))">Delete</MudMenuItem>
                                    </MudMenu>
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="@(config.IsVisualRecognition ? Color.Secondary : Color.Primary)">
                                        @(config.IsVisualRecognition ? "Visual" : "Text")
                                    </MudChip>
                                     <MudSwitch T="bool" Value="config.IsActive" ValueChanged="@((bool val) => SetActive(config))" Color="Color.Success" Label="@(config.IsActive ? "Active" : "Inactive")" LabelPosition="LabelPosition.Start" />
                                </MudStack>
                                @if(!string.IsNullOrEmpty(config.ApiBase)) {
                                    <MudText Typo="Typo.caption" Class="d-block mt-2 text-truncate" Color="Color.Default">@config.ApiBase</MudText>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </MudStack>
</MudContainer>

<style>
    .transition-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .transition-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
    }
</style>

@code {
    private List<FuzzAiConfig> _configs = new();
    private List<FuzzAiModel> _allModels = new();
    private List<FuzzAiModel> _availableModels = new();
    private FuzzAiConfig _newConfig = new() { Provider = AiProvider.Gemini, ModelId = "" };
    private string _customModelId = "";
    private string _userId = "";
    private bool _isLoading = true;
    private bool _isSaving = false;
    private int _activeTabIndex = 0;
    private AiProvider _lastCloudProvider = AiProvider.Gemini;
    private string _configMode = "text";

    private Color GetProviderColor(AiProvider provider) => provider switch
    {
        AiProvider.Gemini => Color.Info,
        AiProvider.OpenAI => Color.Success,
        AiProvider.Local => Color.Warning,
        _ => Color.Default
    };

    private string GetProviderIcon(AiProvider provider) => provider switch
    {
        AiProvider.Gemini => Icons.Material.Filled.AutoAwesome,
        AiProvider.OpenAI => Icons.Material.Filled.Bolt,
        AiProvider.Local => Icons.Material.Filled.SettingsInputHdmi,
        _ => Icons.Material.Filled.QuestionMark
    };

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            
            if (!string.IsNullOrEmpty(_userId))
            {
                await LoadModels();
                await LoadConfigs();
                UpdateAvailableModels();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading settings.");
            Snackbar.Add("Failed to initialize settings.", Severity.Error);
        }
    }

    private async Task LoadModels()
    {
        _allModels = await ConfigService.GetModelsAsync();
    }

    private void UpdateAvailableModels()
    {
        var isVisualMode = _configMode == "visual";
        
        if (_newConfig.Provider == AiProvider.Local)
        {
             if (isVisualMode)
            {
                _availableModels = _allModels
                    .Where(m => m.Provider == AiProvider.Local && m.IsVisualRecognition)
                    .ToList();
            }
            else
            {
                // Text Tab: Only text capable models (hides pure visual models like moondream)
                _availableModels = _allModels
                    .Where(m => m.Provider == AiProvider.Local && m.IsTextCapable)
                    .ToList();
            }
        }
        else
        {
             if (isVisualMode)
            {
                // Visual Tab: Only visual capable
                _availableModels = _allModels
                    .Where(m => m.Provider == _newConfig.Provider && m.IsVisualRecognition)
                    .ToList();
            }
            else
            {
                // Text Tab: Only text capable (includes hybrids like GPT-4o)
                _availableModels = _allModels
                    .Where(m => m.Provider == _newConfig.Provider && m.IsTextCapable)
                    .ToList();
            }
        }

        if (!_availableModels.Any(m => m.ModelId == _newConfig.ModelId))
        {
            _newConfig.ModelId = _availableModels.FirstOrDefault()?.ModelId ?? "custom";
        }
    }

    private async Task OnOuterTabChanged(int index)
    {
        // 0 = Text AI, 1 = Visual AI
        _configMode = index == 0 ? "text" : "visual";
        
        // Reset provider logic if needed, or keep last selected
        _newConfig.Provider = _lastCloudProvider; 
        
        // Reset inner tab to cloud (index 0) or keep logic? 
        // Better to reset to Cloud (0) usually
        // But _newConfig defaults to Cloud.
        
        UpdateAvailableModels();
        await Task.CompletedTask;
    }

    private async Task OnInnerTabChanged(int index)
    {
        // 0 = Cloud, 1 = Local
        if (index == 1) 
        {
            _newConfig.Provider = AiProvider.Local;
            await RefreshLocalModels();
        }
        else 
        {
            _newConfig.Provider = _lastCloudProvider;
        }
        
        UpdateAvailableModels();
    }

    private async Task OnProviderChanged(AiProvider provider)
    {
        _newConfig.Provider = provider;
        if (provider != AiProvider.Local)
        {
            _lastCloudProvider = provider;
        }
        UpdateAvailableModels();
    }

    private async Task RefreshLocalModels()
    {
        try
        {
            var localModels = await ConfigService.GetLocalModelsAsync(_newConfig.ApiBase);
            await LoadModels();
            UpdateAvailableModels();
            StateHasChanged();
            
            if (localModels.Any())
                Snackbar.Add($"{localModels.Count} new models found.", Severity.Success);
            else
                Snackbar.Add("No new local models found.", Severity.Info);
        }
        catch (Exception ex)
        {
             Logger.LogWarning("Error refreshing local models: {Message}", ex.Message);
        }
    }

    private async Task LoadConfigs()
    {
        if (string.IsNullOrEmpty(_userId)) return;

        _isLoading = true;
        try
        {
            _configs = await ConfigService.GetUserConfigsAsync(_userId);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AddConfiguration()
    {
        if (string.IsNullOrEmpty(_userId)) return;

        if (_newConfig.ModelId == "custom" && string.IsNullOrWhiteSpace(_customModelId))
        {
            Snackbar.Add("Please enter a custom model ID.", Severity.Warning);
            return;
        }

        _isSaving = true;
        try
        {
            if (_newConfig.ModelId == "custom")
            {
                await ConfigService.AddCustomModelAsync(_newConfig.Provider, _customModelId);
                await LoadModels();
                _newConfig.ModelId = _customModelId;
            }

            _newConfig.UserId = _userId;
            _newConfig.UpdatedAt = DateTime.UtcNow;
            _newConfig.IsActive = !_configs.Any(); // First one is active
            _newConfig.IsVisualRecognition = (_configMode == "visual");

            await ConfigService.AddConfigAsync(_newConfig);
            Snackbar.Add("Agent configured successfully.", Severity.Success);
            
            var provider = _newConfig.Provider;
            _newConfig = new FuzzAiConfig { Provider = provider, ModelId = "" }; // Reset
            _customModelId = "";
            UpdateAvailableModels();
            
            await LoadConfigs();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task SetActive(FuzzAiConfig config)
    {
        // Deactivate others of the same type
        foreach(var c in _configs.Where(x => x.IsVisualRecognition == config.IsVisualRecognition)) 
        {
            c.IsActive = false;
        }
        
        config.IsActive = true;
        StateHasChanged();

        try
        {
            await ConfigService.SetActiveConfigAsync(config.Id, _userId);
            // Optionally reload to be sure
            await LoadConfigs(); 
        }
        catch
        {
            Snackbar.Add("Failed to update status.", Severity.Error);
            await LoadConfigs();
        }
    }

    private async Task DeleteConfig(int id)
    {
        await ConfigService.DeleteConfigAsync(id);
        await LoadConfigs();
    }

    private async Task OpenParametersDialog(int configId)
    {
        var parameters = new DialogParameters { ["ConfigId"] = configId };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<AiParameterDialog>("Parameters", parameters, options);
    }
}
