@page "/agent-todo"
@rendermode InteractiveServer
@using Fuzz.Domain.Entities
@using Fuzz.Domain.Services
@using Fuzz.Domain.Services.Interfaces
@using Fuzz.Web.Components.Pages.Shared
@inject IFuzzAgentService AgentService
@inject IAiConfigService ConfigService
@inject AuthenticationStateProvider AuthProvider

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-4 chat-container">
        
        <PageHeader Title="Fuzz Task Agent" 
                    Subtitle="Database & Todo Assistant" 
                    Icon="@Icons.Material.Filled.TaskAlt"
                    IconColor="Color.Primary"
                    IsActive="@_isActive">
            @if (!string.IsNullOrEmpty(_globalLastSql))
            {
                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Filled">SQL</MudChip>
            }
        </PageHeader>
        
        @if (!string.IsNullOrEmpty(_globalLastSql))
        {
            <MudPaper Elevation="0" Class="pa-3 mb-4 sql-monitor">
                <MudText Typo="Typo.caption" Class="mb-1" Style="color: #ce9178; font-weight: bold;">
                    Last SQL Query
                </MudText>
                <code class="sql-code">@_globalLastSql</code>
            </MudPaper>
        }

        <div class="chat-messages" @ref="_chatContainer">
            @foreach (var msg in _messages)
            {
                <ChatBubble Message="@msg.Content" 
                            IsUser="@msg.IsUser" 
                            Timestamp="@msg.Timestamp" />
            }
            
            @if (_isProcessing)
            {
                <div class="chat-bubble-wrapper agent">
                    <MudAvatar Color="Color.Primary" Size="Size.Small" Class="chat-avatar">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="Size.Small" />
                    </MudAvatar>
                    <div class="chat-bubble agent-bubble typing">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
                        <span class="ml-2">Working on tasks...</span>
                    </div>
                </div>
            }
        </div>

        <ChatInput @bind-Value="_currentInput" 
                   Placeholder="Ask to create tasks, query todos..." 
                   IsProcessing="@_isProcessing"
                   OnSend="SendMessage" />
    </MudPaper>
</MudContainer>

<style>
    .chat-container {
        background: rgba(26, 26, 46, 0.7) !important;
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 107, 53, 0.15);
        border-radius: 20px !important;
        height: 80vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding-right: 8px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .sql-monitor {
        background: rgba(15, 15, 35, 0.8) !important;
        border-left: 3px solid #FF6B35;
        border-radius: 8px !important;
    }
    
    .sql-code {
        display: block;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.75rem;
        color: #569cd6;
        max-height: 50px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* Typing bubble */
    .chat-bubble-wrapper.agent {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        flex-direction: row;
        justify-content: flex-start;
    }
    
    .agent-bubble {
        background: rgba(40, 40, 60, 0.9);
        color: #E0E0E0;
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(255, 107, 53, 0.2);
        border-radius: 16px;
        max-width: 75%;
    }

    .typing {
        padding: 8px 16px;
        display: flex;
        align-items: center;
    }
</style>

@code {
    private List<ChatMessage> _messages = new();
    private string _currentInput = "";
    private string _globalLastSql = "";
    private bool _isProcessing = false;
    private bool _isActive = false;
    private ElementReference _chatContainer;

    private class ChatMessage
    {
        public string Content { get; set; } = "";
        public bool IsUser { get; set; }
        public DateTime Timestamp { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "guest";
        
        // Check for active Text config (same provider used for tasks)
        var config = await ConfigService.GetActiveConfigAsync(userId, mode: AiCapabilities.Text);
        _isActive = config != null;
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_currentInput)) return;

        var input = _currentInput;
        _currentInput = "";
        _isProcessing = true;

        _messages.Add(new ChatMessage { Content = input, IsUser = true, Timestamp = DateTime.Now });

        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "guest";

            var response = await AgentService.ProcessCommandAsync(input, userId, useTools: true);
            
            if (!string.IsNullOrEmpty(response.LastSql))
                _globalLastSql = response.LastSql;

            _messages.Add(new ChatMessage { Content = response.Answer, IsUser = false, Timestamp = DateTime.Now });
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatMessage { Content = $"Error: {ex.Message}", IsUser = false, Timestamp = DateTime.Now });
        }
        finally
        {
            _isProcessing = false;
        }
    }
}
