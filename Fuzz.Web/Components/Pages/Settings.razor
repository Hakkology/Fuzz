@page "/Settings"
@using Fuzz.Domain.Data
@using Fuzz.Domain.Entities
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject IAiConfigService ConfigService
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar
@inject ILogger<Settings> Logger

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudStack Spacing="6">
        @* Başlık Bölümü *@
        <MudPaper Elevation="4" Class="pa-8 blur-card">
            <MudStack Spacing="4">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h4" Class="gradient-text">AI Ayarları</MudText>
                </MudStack>
                <MudText Typo="Typo.body2" Style="color: #B0B0B0;">
                    Sisteme OpenAI veya Gemini API anahtarlarınızı ekleyin ve aktif olanı seçin.
                    <br /><b>Not:</b> Değişiklikler anında veritabanına kaydedilir.
                </MudText>
            </MudStack>
        </MudPaper>

        @* Yeni Anahtar Ekleme Formu *@
        <MudPaper Elevation="4" Class="pa-8 blur-card">
            <MudStack Spacing="4">
                <MudText Typo="Typo.h6" Color="Color.Primary">Yeni Yapılandırma Ekle</MudText>
                <MudGrid>
                    <MudItem xs="12" sm="3">
                        <MudSelect T="AiProvider" Value="_newConfig.Provider" ValueChanged="OnProviderChanged" Label="Sağlayıcı" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@AiProvider.Gemini">Gemini</MudSelectItem>
                            <MudSelectItem Value="@AiProvider.OpenAI">OpenAI</MudSelectItem>
                            <MudSelectItem Value="@AiProvider.Local">Yerel (Ollama / v1)</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center">
                            <MudSelect T="string" @bind-Value="_newConfig.ModelId" Label="Model" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                @foreach (var model in _availableModels)
                                {
                                    <MudSelectItem Value="@model.ModelId">@model.DisplayName</MudSelectItem>
                                }
                                @if (_newConfig.Provider == AiProvider.Local)
                                {
                                    <MudSelectItem Value="@("custom")">-- Özel Model Gir --</MudSelectItem>
                                }
                            </MudSelect>
                            @if (_newConfig.Provider == AiProvider.Local)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Primary" OnClick="RefreshLocalModels" Title="Ollama Modellerini Tara" />
                            }
                        </MudStack>
                    </MudItem>
                    @if (_newConfig.ModelId == "custom")
                    {
                        <MudItem xs="12" sm="3">
                            <MudTextField @bind-Value="_customModelId" Label="Özel Model Adı" Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                    }
                    <MudItem xs="12" sm="@(_newConfig.Provider == AiProvider.Local ? 3 : 6)">
                        <MudTextField @bind-Value="_newConfig.ApiKey" Label="@(_newConfig.Provider == AiProvider.Local ? "API Key (Opsiyonel)" : "API Key")" InputType="InputType.Password" Variant="Variant.Outlined" Required="@(_newConfig.Provider != AiProvider.Local)" />
                    </MudItem>
                    @if (_newConfig.Provider == AiProvider.Local)
                    {
                        <MudItem xs="12" sm="3">
                            <MudTextField @bind-Value="_newConfig.ApiBase" Label="API Base URL" Placeholder="http://localhost:11434/v1" Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                    }
                </MudGrid>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddConfiguration" Disabled="_isSaving" FullWidth="false" Class="align-self-end">
                    Listeye Ekle
                </MudButton>
            </MudStack>
        </MudPaper>

        @* Mevcut Yapılandırmalar Listesi *@
        <MudPaper Elevation="4" Class="pa-8 blur-card">
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-4">Mevcut Anahtarlar</MudText>
            @if (_isLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            else if (!_configs.Any())
            {
                <MudAlert Severity="Severity.Info" Class="blur-alert">Henüz bir API anahtarı eklenmemiş.</MudAlert>
            }
            else
            {
                <MudTable Items="_configs" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="0" Class="transparent-table">
                    <HeaderContent>
                        <MudTh>Sağlayıcı</MudTh>
                        <MudTh>Model / Endpoint</MudTh>
                        <MudTh>API Key</MudTh>
                        <MudTh>Durum (Aktif)</MudTh>
                        <MudTh>İşlem</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Sağlayıcı">
                            <MudChip T="string" Color="@GetProviderColor(context.Provider)" Size="Size.Small">@context.Provider</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Model">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">@context.ModelId</MudText>
                                @if (!string.IsNullOrEmpty(context.ApiBase))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Default" Style="opacity: 0.6">@context.ApiBase</MudText>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="API Key">@(string.IsNullOrEmpty(context.ApiKey) ? "Yok" : "*******")</MudTd>
                        <MudTd DataLabel="Aktif">
                            <MudSwitch T="bool" Value="context.IsActive" ValueChanged="@((bool val) => SetActive(context))" Color="Color.Primary" UnCheckedColor="Color.Default" />
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteConfig(context.Id))" Size="Size.Small" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudPaper>
    </MudStack>
</MudContainer>

<style>
    .blur-card {
        background: rgba(26, 26, 46, 0.8) !important;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 107, 53, 0.2);
        border-radius: 20px !important;
    }
    
    .gradient-text {
        background: linear-gradient(135deg, #FF6B35, #FF8F5E);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
    }

    .transparent-table {
        background: transparent !important;
    }

    .transparent-table th {
        color: #FF6B35 !important;
        font-weight: bold;
    }

    .transparent-table td {
        color: white !important;
    }

    .blur-alert {
        background: rgba(255, 255, 255, 0.05) !important;
        color: white !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
</style>

@code {
    private List<FuzzAiConfig> _configs = new();
    private List<FuzzAiModel> _allModels = new();
    private List<FuzzAiModel> _availableModels = new();
    private FuzzAiConfig _newConfig = new() { Provider = AiProvider.Gemini, ModelId = "" };
    private string _customModelId = "";
    private string _userId = "";
    private bool _isLoading = true;
    private bool _isSaving = false;

    private Color GetProviderColor(AiProvider provider) => provider switch
    {
        AiProvider.Gemini => Color.Info,
        AiProvider.OpenAI => Color.Success,
        AiProvider.Local => Color.Warning,
        _ => Color.Default
    };

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            
            if (string.IsNullOrEmpty(_userId))
            {
                Logger.LogWarning("Ayarlar sayfası: Kullanıcı ID bulunamadı.");
            }
            
            await LoadModels();
            await LoadConfigs();
            UpdateAvailableModels();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ayarlar yüklenirken hata oluştu.");
            Snackbar.Add("Sistem yüklenirken bir hata oluştu.", Severity.Error);
        }
    }

    private async Task LoadModels()
    {
        _allModels = await ConfigService.GetModelsAsync();
    }

    private void UpdateAvailableModels()
    {
        _availableModels = _allModels.Where(m => m.Provider == _newConfig.Provider).ToList();
        if (!_availableModels.Any(m => m.ModelId == _newConfig.ModelId))
        {
            _newConfig.ModelId = _availableModels.FirstOrDefault()?.ModelId ?? "custom";
        }
    }

    private async Task OnProviderChanged(AiProvider provider)
    {
        _newConfig.Provider = provider;
        if (provider == AiProvider.Local)
        {
            await RefreshLocalModels();
        }
        else
        {
            UpdateAvailableModels();
        }
    }

    private async Task RefreshLocalModels()
    {
        try
        {
            var localModels = await ConfigService.GetLocalModelsAsync(_newConfig.ApiBase);
            await LoadModels();
            UpdateAvailableModels();
            StateHasChanged();
            
            if (localModels.Any())
            {
                Snackbar.Add($"{localModels.Count} adet local model bulundu ve sisteme eklendi.", Severity.Success);
            }
            else
            {
                Snackbar.Add("Local model bulunamadı. Ollama'nın çalıştığından emin olun.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning("Local modeller yenilenirken hata: {Message}", ex.Message);
        }
    }

    private async Task LoadConfigs()
    {
        if (string.IsNullOrEmpty(_userId)) return;

        _isLoading = true;
        try
        {
            _configs = await ConfigService.GetUserConfigsAsync(_userId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Yapılandırmalar çekilemedi.");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AddConfiguration()
    {
        if (string.IsNullOrEmpty(_userId))
        {
            Snackbar.Add("Kullanıcı oturumu bulunamadı.", Severity.Error);
            return;
        }

        if (_newConfig.ModelId == "custom" && string.IsNullOrWhiteSpace(_customModelId))
        {
            Snackbar.Add("Lütfen özel model adını girin.", Severity.Warning);
            return;
        }

        _isSaving = true;
        StateHasChanged();

        try
        {
            // Eğer özel model girildiyse, önce servise ekle
            if (_newConfig.ModelId == "custom")
            {
                await ConfigService.AddCustomModelAsync(_newConfig.Provider, _customModelId);
                await LoadModels();
                _newConfig.ModelId = _customModelId;
            }

            _newConfig.UserId = _userId;
            _newConfig.UpdatedAt = DateTime.UtcNow;
            _newConfig.IsActive = !_configs.Any();

            await ConfigService.AddConfigAsync(_newConfig);

            Snackbar.Add("Yapılandırma başarıyla eklendi.", Severity.Success);
            
            // Reset form
            var currentProvider = _newConfig.Provider;
            _newConfig = new FuzzAiConfig { Provider = currentProvider, ModelId = "" };
            UpdateAvailableModels();
            _customModelId = "";
            
            await LoadConfigs();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Yapılandırma kaydedilemedi.");
            Snackbar.Add($"Kaydetme hatası: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task SetActive(FuzzAiConfig config)
    {
        try
        {
            await ConfigService.SetActiveConfigAsync(config.Id, _userId);
            await LoadConfigs();
            Snackbar.Add($"{config.Provider} şu an aktif sağlayıcı.", Severity.Info);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Aktif yapılandırma değiştirilemedi.");
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteConfig(int id)
    {
        try
        {
            await ConfigService.DeleteConfigAsync(id);
            await LoadConfigs();
            Snackbar.Add("Yapılandırma silindi.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Yapılandırma silinemedi.");
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
    }
}
