@page "/Settings"
@using Fuzz.Domain.Data
@using Fuzz.Domain.Entities
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject IAiConfigService ConfigService
@inject AuthenticationStateProvider AuthProvider
@inject ISnackbar Snackbar
@inject ILogger<Settings> Logger

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudStack Spacing="6">
        @* Header Section *@
        <MudPaper Elevation="4" Class="pa-8 blur-card header-bg">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                <div class="icon-pulse">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Color="Color.Primary" Style="font-size: 3rem;" />
                </div>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h4" Class="gradient-text">Yapay Zeka Yapılandırması</MudText>
                    <MudText Typo="Typo.body2" Style="color: #B0B0B0;">Servis sağlayıcılarınızı ve modellerinizi buradan yönetin.</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>

        <MudTabs ActivePanelIndex="_activeTabIndex" ActivePanelIndexChanged="OnTabChanged" Elevation="4" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-8 blur-card mt-4" Class="custom-tabs">
            @* --- Cloud API Tab --- *@
            <MudTabPanel Text="Bulut Servisleri (API)" Icon="@Icons.Material.Filled.CloudQueue">
                <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-6">Yeni Cloud Yapılandırması</MudText>
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="AiProvider" Value="_newConfig.Provider" ValueChanged="OnProviderChanged" Label="Servis Sağlayıcı" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@AiProvider.Gemini">Google Gemini</MudSelectItem>
                            <MudSelectItem Value="@AiProvider.OpenAI">OpenAI</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="string" @bind-Value="_newConfig.ModelId" Label="Model Seçimi" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var model in _availableModels.Where(m => m.Provider != AiProvider.Local))
                            {
                                <MudSelectItem Value="@model.ModelId">@model.DisplayName</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_newConfig.ApiKey" Label="API Key" InputType="InputType.Password" Variant="Variant.Outlined" Required="true" 
                                      HelperText="API anahtarınız güvenli bir şekilde saklanır." />
                    </MudItem>
                    <MudItem xs="12" Class="d-flex justify-end">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddConfiguration" Disabled="_isSaving" Class="px-8 py-3 rounded-pill">
                            Yapılandırmayı Ekle
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            @* --- Local AI Tab --- *@
            <MudTabPanel Text="Yerel Yapay Zeka (Ollama)" Icon="@Icons.Material.Filled.Dns">
                <MudStack Spacing="6">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-2">
                        Yerel modeller için <b>Ollama</b> veya OpenAI uyumlu bir API servisinin çalışıyor olması gereklidir.
                    </MudAlert>

                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTooltip Text="Varsayılan: http://localhost:11434. Farklı bir port veya adres kullanıyorsanız güncelleyiniz.">
                                <MudTextField @bind-Value="_newConfig.ApiBase" Label="API Base URL (Ollama / Local)" Placeholder="http://localhost:11434" Variant="Variant.Outlined" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Link" />
                            </MudTooltip>
                        </MudItem>
                        <MudItem xs="12" sm="6" Class="d-flex align-center">
                            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.AutoFixHigh" OnClick="RefreshLocalModels" FullWidth="true" Style="height: 56px;" Class="rounded-lg">
                                Modelleri Otomatik Tara (Ollama)
                            </MudButton>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6">
                            <MudSelect T="string" @bind-Value="_newConfig.ModelId" Label="Model Seçimi" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                @foreach (var model in _availableModels.Where(m => m.Provider == AiProvider.Local))
                                {
                                    <MudSelectItem Value="@model.ModelId">@model.DisplayName</MudSelectItem>
                                }
                                <MudSelectItem Value="@("custom")">-- Özel Model Gir --</MudSelectItem>
                            </MudSelect>
                        </MudItem>

                        @if (_newConfig.ModelId == "custom")
                        {
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_customModelId" Label="Özel Model ID (Örn: deepseek-r1:7b)" Variant="Variant.Outlined" Required="true" />
                            </MudItem>
                        }

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_newConfig.ApiKey" Label="API Key (Gerekliyse)" InputType="InputType.Password" Variant="Variant.Outlined" Placeholder="Genellikle boş bırakılır" />
                        </MudItem>

                        <MudItem xs="12" Class="d-flex justify-end mt-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Add" OnClick="AddConfiguration" Disabled="_isSaving" Class="px-8 py-3 rounded-pill" Style="color: #1a1a2e; font-weight: bold;">
                                Yerel Yapılandırmayı Kaydet
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudStack>
            </MudTabPanel>
        </MudTabs>

        @* Active Configurations List *@
        <MudPaper Elevation="4" Class="pa-8 blur-card mt-6">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
                <MudText Typo="Typo.h6" Color="Color.Primary">Mevcut Yapılandırmalarınız</MudText>
                @if (_isLoading) { <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" /> }
            </MudStack>

            @if (!_configs.Any() && !_isLoading)
            {
                <MudAlert Severity="Severity.Info" Class="blur-alert py-6">Henüz bir API anahtarı eklenmemiş. Yukarıdaki sekmelerden birini kullanarak başlayın.</MudAlert>
            }
            else
            {
                <MudTable Items="_configs" Hover="true" Elevation="0" Class="transparent-table" Loading="_isLoading">
                    <HeaderContent>
                        <MudTh>Servis</MudTh>
                        <MudTh>Model Detayı</MudTh>
                        <MudTh>Durum</MudTh>
                        <MudTh Style="width: 150px">Aktif Et</MudTh>
                        <MudTh Style="width: 50px"></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudChip T="string" Color="@GetProviderColor(context.Provider)" Variant="Variant.Text" Icon="@GetProviderIcon(context.Provider)">@context.Provider</MudChip>
                        </MudTd>
                        <MudTd>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body1" Style="font-weight: 500">@context.ModelId</MudText>
                                @if (!string.IsNullOrEmpty(context.ApiBase))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Default" Style="opacity: 0.6">@context.ApiBase</MudText>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd>
                            @if (context.IsActive)
                            {
                                <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">AKTİF</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Style="color: #666">Beklemede</MudChip>
                            }
                        </MudTd>
                        <MudTd>
                            <MudSwitch T="bool" Value="context.IsActive" ValueChanged="@((bool val) => SetActive(context))" Color="Color.Primary" UnCheckedColor="Color.Default" />
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.DeleteOutline" Color="Color.Error" OnClick="@(() => DeleteConfig(context.Id))" Size="Size.Small" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudPaper>
    </MudStack>
</MudContainer>

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #FF6B35 0%, #FF8F5E 100%);
        --glass-bg: rgba(26, 26, 46, 0.85);
        --glass-border: rgba(255, 107, 53, 0.25);
    }

    .blur-card {
        background: var(--glass-bg) !important;
        backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid var(--glass-border);
        border-radius: 24px !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header-bg {
        background: linear-gradient(225deg, rgba(255, 107, 53, 0.1) 0%, rgba(26, 26, 46, 0.9) 100%) !important;
    }

    .gradient-text {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        letter-spacing: -0.5px;
    }

    .custom-tabs .mud-tabs-tab {
        color: #B0B0B0 !important;
        font-weight: 600;
        padding: 16px 24px;
        transition: color 0.3s;
    }

    .custom-tabs .mud-tab-active {
        color: #FF6B35 !important;
        background: rgba(255, 107, 53, 0.05);
    }

    .custom-tabs .mud-tabs-slider {
        background-color: #FF6B35 !important;
        height: 3px;
        border-radius: 3px;
    }

    .transparent-table { background: transparent !important; }
    .transparent-table th { color: #FF6B35 !important; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
    .transparent-table td { color: white !important; border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important; padding: 16px 8px !important; }

    .icon-pulse {
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    .align-self-end { align-self: flex-end; }
    .rounded-pill { border-radius: 50px !important; }
</style>

@code {
    private List<FuzzAiConfig> _configs = new();
    private List<FuzzAiModel> _allModels = new();
    private List<FuzzAiModel> _availableModels = new();
    private FuzzAiConfig _newConfig = new() { Provider = AiProvider.Gemini, ModelId = "" };
    private string _customModelId = "";
    private string _userId = "";
    private bool _isLoading = true;
    private bool _isSaving = false;
    private int _activeTabIndex = 0;
    private AiProvider _lastCloudProvider = AiProvider.Gemini;

    private Color GetProviderColor(AiProvider provider) => provider switch
    {
        AiProvider.Gemini => Color.Info,
        AiProvider.OpenAI => Color.Success,
        AiProvider.Local => Color.Warning,
        _ => Color.Default
    };

    private string GetProviderIcon(AiProvider provider) => provider switch
    {
        AiProvider.Gemini => Icons.Material.Filled.AutoAwesome,
        AiProvider.OpenAI => Icons.Material.Filled.Bolt,
        AiProvider.Local => Icons.Material.Filled.SettingsInputHdmi,
        _ => Icons.Material.Filled.QuestionMark
    };

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            
            if (string.IsNullOrEmpty(_userId))
            {
                Logger.LogWarning("Ayarlar sayfası: Kullanıcı ID bulunamadı.");
            }
            
            await LoadModels();
            await LoadConfigs();
            UpdateAvailableModels();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ayarlar yüklenirken hata oluştu.");
            Snackbar.Add("Sistem yüklenirken bir hata oluştu.", Severity.Error);
        }
    }

    private async Task LoadModels()
    {
        _allModels = await ConfigService.GetModelsAsync();
    }

    private void UpdateAvailableModels()
    {
        _availableModels = _allModels.Where(m => m.Provider == _newConfig.Provider).ToList();
        if (!_availableModels.Any(m => m.ModelId == _newConfig.ModelId))
        {
            _newConfig.ModelId = _availableModels.FirstOrDefault()?.ModelId ?? "custom";
        }
    }

    private async Task OnTabChanged(int index)
    {
        _activeTabIndex = index;
        if (index == 1) // Local Tab
        {
            _newConfig.Provider = AiProvider.Local;
        }
        else // Cloud Tab
        {
            _newConfig.Provider = _lastCloudProvider;
        }
        
        UpdateAvailableModels();

        if (index == 1)
        {
            await RefreshLocalModels();
        }
    }

    private async Task OnProviderChanged(AiProvider provider)
    {
        _newConfig.Provider = provider;
        if (provider != AiProvider.Local)
        {
            _lastCloudProvider = provider;
        }
        UpdateAvailableModels();
    }

    private async Task RefreshLocalModels()
    {
        try
        {
            var localModels = await ConfigService.GetLocalModelsAsync(_newConfig.ApiBase);
            await LoadModels();
            UpdateAvailableModels();
            StateHasChanged();
            
            if (localModels.Any())
            {
                Snackbar.Add($"{localModels.Count} adet local model bulundu ve sisteme eklendi.", Severity.Success);
            }
            else
            {
                Snackbar.Add("Local model bulunamadı. Ollama'nın çalıştığından emin olun.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning("Local modeller yenilenirken hata: {Message}", ex.Message);
        }
    }

    private async Task LoadConfigs()
    {
        if (string.IsNullOrEmpty(_userId)) return;

        _isLoading = true;
        try
        {
            _configs = await ConfigService.GetUserConfigsAsync(_userId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Yapılandırmalar çekilemedi.");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AddConfiguration()
    {
        if (string.IsNullOrEmpty(_userId))
        {
            Snackbar.Add("Kullanıcı oturumu bulunamadı.", Severity.Error);
            return;
        }

        if (_newConfig.ModelId == "custom" && string.IsNullOrWhiteSpace(_customModelId))
        {
            Snackbar.Add("Lütfen özel model adını girin.", Severity.Warning);
            return;
        }

        _isSaving = true;
        StateHasChanged();

        try
        {
            // Eğer özel model girildiyse, önce servise ekle
            if (_newConfig.ModelId == "custom")
            {
                await ConfigService.AddCustomModelAsync(_newConfig.Provider, _customModelId);
                await LoadModels();
                _newConfig.ModelId = _customModelId;
            }

            _newConfig.UserId = _userId;
            _newConfig.UpdatedAt = DateTime.UtcNow;
            _newConfig.IsActive = !_configs.Any();

            await ConfigService.AddConfigAsync(_newConfig);

            Snackbar.Add("Yapılandırma başarıyla eklendi.", Severity.Success);
            
            // Reset form
            var currentProvider = _newConfig.Provider;
            _newConfig = new FuzzAiConfig { Provider = currentProvider, ModelId = "" };
            UpdateAvailableModels();
            _customModelId = "";
            
            await LoadConfigs();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Yapılandırma kaydedilemedi.");
            Snackbar.Add($"Kaydetme hatası: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task SetActive(FuzzAiConfig config)
    {
        // Hızlı geri bildirim için yerel durumu hemen güncelle (Optimistic UI)
        foreach (var c in _configs)
        {
            c.IsActive = (c.Id == config.Id);
        }
        StateHasChanged();

        try
        {
            await ConfigService.SetActiveConfigAsync(config.Id, _userId);
            // Veritabanından son durumu teyit et
            await LoadConfigs();
            Snackbar.Add($"{config.Provider} şu an aktif sağlayıcı.", Severity.Info);
        }
        catch (Exception ex)
        {
            await LoadConfigs(); // Hata durumunda eski hali geri yükle
            Logger.LogError(ex, "Aktif yapılandırma değiştirilemedi.");
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task DeleteConfig(int id)
    {
        try
        {
            await ConfigService.DeleteConfigAsync(id);
            await LoadConfigs();
            Snackbar.Add("Yapılandırma silindi.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Yapılandırma silinemedi.");
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
    }
}
