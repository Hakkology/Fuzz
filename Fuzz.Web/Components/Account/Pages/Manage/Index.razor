@page "/Account/Manage"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Fuzz.Domain.Data

@inject UserManager<FuzzUser> UserManager
@inject SignInManager<FuzzUser> SignInManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <StatusMessage />
    
    <EditForm Model="Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post">
        <DataAnnotationsValidator />
        
        <MudCard Elevation="4" Class="pa-6">
            <MudStack Spacing="4">
                <MudText Typo="Typo.h5" GutterBottom="true" Color="Color.Primary" Style="font-weight: 700;">Profile</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">Manage your account details below.</MudText>
                
                <MudTextField T="string" Value="@username" Label="Username" ReadOnly="true" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" />
                
                <MudTextField @bind-Value="Input.PhoneNumber" For="@(() => Input.PhoneNumber)" Label="Phone number" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Phone" />
                
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true" Class="mt-4">
                    Save Changes
                </MudButton>
            </MudStack>
        </MudCard>
    </EditForm>
</MudContainer>

@code {
    private FuzzUser? user;
    private string? username;
    private string? phoneNumber;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        username = await UserManager.GetUserNameAsync(user);
        phoneNumber = await UserManager.GetPhoneNumberAsync(user);

        Input.PhoneNumber ??= phoneNumber;
    }

    private async Task OnValidSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        if (Input.PhoneNumber != phoneNumber)
        {
            var setPhoneResult = await UserManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
            if (!setPhoneResult.Succeeded)
            {
                RedirectManager.RedirectToCurrentPageWithStatus("Error: Failed to set phone number.", HttpContext);
                return;
            }
        }

        await SignInManager.RefreshSignInAsync(user);
        RedirectManager.RedirectToCurrentPageWithStatus("Your profile has been updated", HttpContext);
    }

    private sealed class InputModel
    {
        [Phone]
        [Display(Name = "Phone number")]
        public string? PhoneNumber { get; set; }
    }
}
